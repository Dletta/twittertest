<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>E2EEC</title>
    <link rel="stylesheet" href="e2eec.css">
  </head>
  <body>
		<script src="../../gun.js"></script>
		<script src="../../sea.js"></script>
    <div id='signer'>
      <input type="text" id="username"> <input type="password" id="passphrase"><br>
      <button onclick='createUser()'>Create</button> <button onclick="signIn()">Sign In</button>
    </div>
    <div id='pubkey'>
      Your UserName : <span id='name'></span>
      Your ePub : <input id='epub' value=''>
    </div>
    <div id='chat'>
      <div id='chatcont' class="chatcont">

      </div>
      <div class="write">
        <span>Type here: </span><input type="text" class="input" id='chatIn'>
        <button type="button" onclick='send()' class="button">send</button>
      </div>
      <div class="security">
        Add Pubkey of person to chat with: <input type="text" id="addepub">
        <button type="button" class="button" onclick="addEpub()">Add</button><br>
        <p id="list"></p>
      </div>
    </div>
    <script type="text/javascript">
      var peers = ['https://E2EEC.herokuapp.com/gun']
      var gun = Gun({peers:peers});
      var app = gun.get('app').put({});
      var user = gun.user();
      var name = '';
      SEA.throw = true;

      var chatParticipants = [];


      function addChat (data, pub) {
        console.log('data received');
        console.log(data);
        gun.user(pub).get('epub').once(step.bind(null, data))

      };

      function step (data, epub) {
        console.log('step');
        console.log(epub, data);
        SEA.secret(epub, user._.sea, step2.bind(null, data));
      }

      function step2 (data, key) {
        console.log('decrypt');
        SEA.decrypt(data, key, decrypted);
      }

      function decrypted(data) {
        console.log('decrypted', data);
        var cont = document.getElementById('chatcont');
        var chat = document.createElement('p');
        chat.setAttribute('class', 'chat')
        var name = document.createTextNode(data.name);
        var msg = document.createTextNode(data.text);
        var time = document.createTextNode(data.date);
        var br = document.createElement('br');
        chat.appendChild(name);
        chat.appendChild(br);
        var br = document.createElement('br');
        chat.appendChild(msg);
        chat.appendChild(br);
        chat.appendChild(time);
        cont.prepend(chat);
      };

      function createUser () {
        var uName = document.getElementById('username').value;
        var passP = document.getElementById('passphrase').value;
        console.log(`Called user create`);
        user.create(uName, passP, console.log);
      }

      function signIn () {
        var uName = document.getElementById('username').value;
        name = uName;
        document.getElementById('name').innerHTML = name;
        document.getElementById('username').value = '';
        var passP = document.getElementById('passphrase').value;
        document.getElementById('passphrase').value = '';
        console.log(`Called user signin`);
        user.auth(uName, passP, function(ack) {
          console.log(ack);
          gun.user().once(function(data, key) {
            console.log(data);
            var epub = document.getElementById('epub');
            epub.value = data.pub; // <-- change all epub to pub in UI and ids
          });
        });
      }

      function addEpub () {
        var val = document.getElementById('addepub').value;
        document.getElementById('addepub').value = '';
        var mypub = document.getElementById('epub').value;
        chatParticipants.push(val); //pubkey
        var list = document.getElementById('list');
        list.innerHTML = chatParticipants.toString();
        gun.user(val).get('chat').get(mypub).on((data) => {addChat(data, val);})
      }

      function send() {
        var msg = document.getElementById('chatIn');
        var temp = {};
        temp.date = (new Date()).toString();
        temp.name = name;
        temp.text = msg.value;
        msg.value = '';
        //gun.user().get('message').set(temp);

        var i = 0;
        var l = chatParticipants.length;
        for(i;i<l;i++) {
          gun.user(chatParticipants[i]).once(setup.bind(null, chatParticipants[i], temp));
        }
      } //add another step for key retrieval to avoid calling gun.user().pair()

      function setup (pub, message, userObj) {
        console.log(pub, message, userObj);
        console.log('setup');
        gun.user(pub).once(secret.bind(null, userObj, message, pub));
      }

      function secret(userObj, message, pub, person) {
        console.log(userObj, message, person);
        console.log('secret');
        SEA.secret(person.epub, user._.sea, encrypt.bind(null, message, pub));
      }

      function encrypt(message, pub, key) {
        console.log('encrypt', key);
        var message = JSON.stringify(message);
        SEA.encrypt(message, key, sendEncrypt.bind(null, pub));
      }

      function sendEncrypt (pub, encr) {
        console.log(encr, pub);
        gun.user().get('chat').get(pub).put(encr);
      }

    </script>
  </body>
</html>
